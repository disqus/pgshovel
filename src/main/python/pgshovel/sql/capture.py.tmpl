serialize = SD.get('serialize')
if not serialize:
    serialize = SD['serialize'] = __import__('cPickle').dumps

statements = SD.get('statements')
if not statements:
    statements = SD['statements'] = {
        'enqueue': plpy.prepare('SELECT pgq.insert_event($1, $2, $3)', ["text", "text", "text"]),
        'transaction': plpy.prepare('SELECT txid_current(), (extract(epoch from now()) * 1e6)::bigint'),
    }

(queue, version) = TD['args']
plpy.execute(statements['enqueue'], (queue, 'operation', '0:%s' % serialize((
    TD['table_name'],
    TD['event'],
    (TD['old'], TD['new']),
    version,
    plpy.execute(statements['transaction'])[0].values(),
))))
