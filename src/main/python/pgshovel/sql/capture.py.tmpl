serialize = SD.get('serialize')
if not serialize:
    serialize = SD['serialize'] = __import__('cPickle').dumps

node_id = SD.get('node_id')
if not node_id:
    node_id = SD['node_id'] = plpy.execute(
        plpy.prepare('SELECT convert_from(value, \'utf-8\') as node_id FROM {schema}.configuration WHERE key = $1', ['text']),
        ('node_id',)
    )[0]['node_id']

statements = SD.get('statements')
if not statements:
    statements = SD['statements'] = {{
        'enqueue': plpy.prepare('SELECT pgq.insert_event($1, $2, $3)', ["text", "text", "text"]),
        'transaction': plpy.prepare('SELECT txid_current(), (extract(epoch from now()) * 1e6)::bigint'),
    }}

(queue, version) = TD['args']
plpy.execute(statements['enqueue'], (queue, 'operation', '1:%s' % serialize((
    TD['table_name'],
    TD['event'],
    (TD['old'], TD['new']),
    version,
    plpy.execute(statements['transaction'])[0].values() + [node_id],
))))
